<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>

        body {
          font: 14px "Open Sans" sans-serif;
          color: #7f8c8d;
        }

        #legend {
            position: fixed;
            top: 10px;
            right: 10px;
        }

        #legend .item {
            width: 10px;
            height: 10px;
            display: inline-block;
        }

        .chart-container {
            position: relative;
            margin: 40px;
        }

        .cd-checklist-chart {
            position: relative;
        }

        .cd-checklist-chart-y-axis {
            position: absolute;
            top: 0;
            bottom: 0;
            left: -40px;
            width: 40px;
        }

        .total {
            position: relative;
            border: 5px solid #7f8c8d;
            width: 100px;
            height: 100px;
            justify-content: center;
            display: flex;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            margin: 0 auto;
            color: #000;
            float: left;
        }

        .total:after {
            position: absolute;
            content: 'score';
            top: -24px;
            left: 5px;
            font-size: 14px;
            background: white;
            color: #7f8c8d;
            padding: 10px;
        }

        .delta {
            width: 100px;
            height: 100px;
            justify-content: center;
            display: flex;
            align-items: center;
            font-size: 32px;
            color: black;
            font-weight: bold;
            float: left;
        }

        .clear {
            clear: both;
        }

        .change-i {
            margin-left: 10px;
        }

        .change-i.up {
            color: #4CAF50;
        }

        .change-i.down {
            color: #F44336;
        }

        .change-i.eq {
            color: #FFC107;
            /*transform: rotate(90deg);*/
        }

        .x_tick {
            font-weight: bold;
            color: white;
        }

        .score {
            justify-content: center;
            display: flex;
            align-items: center;
        }

        .focus-list {
            font-size: 16px;

        }

        .focus-list i {
            font-weight: bold;
        }

        .focus {
            color: black;
        }

        h2 {
            text-align: center;
            font-size: 42px;
            font-weight: 300;
        }

        </style>

        <script src="//d3js.org/d3.v3.min.js"></script>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/rickshaw/1.5.1/rickshaw.min.css" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
        <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/rickshaw/1.5.1/rickshaw.min.js"></script>
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

        <script>
            $(document).ready(function () {
                var disrupts = {
                    "2015-08-01": {
                        "focus": [
                            "Single command to run unit tests",
                            "Single command to run acceptance tests",
                            "Production can be deployed to without downtime"
                        ],
                        "behaviours": {
                            "Automated Testing": {
                                "A useful level of code coverage is maintained by the team": true,
                                "All new code has automated tests": true,
                                "Single command to run unit tests": false,
                                "Single command to run acceptance tests": false,
                                "Testers and developers collaborate on writing tests": true,
                                "Tests setup their own test data": true,
                                "Tests complete in less than 10 minutes": false,
                                "Unit tests are written first": false
                            },
                            "Continuous Integration": {
                                "Build scripts are alongside code in a single repository": false,
                                "Developers run tests before pushing and only push when code passes tests": true,
                                "Broken builds are fixed or reverted immediately, and no checkins are made on top of them": false,
                                "Binaries created once for use in all environments": true,
                                "Data migrations and scripts versioned along with the application source code": false
                            },
                            "Deployment": {
                                "Deployment scripts alongside code in a single repository": false,
                                "All release steps tested in a production mirror": true,
                                "Automated deployment to production": false,
                                "Automated smoke tests run during deployment into production": false,
                                "Production can be deployed to without downtime": false,
                                "Problems in production are detectable and visible to the whole team and prioritised like any other work": false,
                                "The health of production systems is easily determinable and visible": true
                            },
                            "Practices": {
                                "Coding standards are agreed upon and followed": true,
                                "Check-ins happen at least once a day": true,
                                "All code is peer reviewed": true,
                                "Changes can be easily reverted": true,
                                "Team practices trunk-based development as a general rule, and knows when it is appropriate to branch": false,
                                "Test results radiated and visible to the whole team": true,
                                "Code is collectively owned, any developer can work on any story": false,
                                "Pair programming used for rapid feedback and is the default way of working in the team": true,
                                "Development and test environment are as similar to production as is economically feasible": true,
                                "Team owns their production system and configuration": false
                            }
                        }
                    },
                    "2015-07-01": {
                        "focus": [
                            "Single command to run unit tests",
                            "Single command to run acceptance tests",
                            "Production can be deployed to without downtime"
                        ],
                        "behaviours": {
                            "Automated Testing": {
                                "A useful level of code coverage is maintained by the team": true,
                                "All new code has automated tests": true,
                                "Single command to run unit tests": false,
                                "Single command to run acceptance tests": false,
                                "Testers and developers collaborate on writing tests": true,
                                "Tests setup their own test data": true,
                                "Tests complete in less than 10 minutes": false,
                                "Unit tests are written first": false
                            },
                            "Continuous Integration": {
                                "Build scripts are alongside code in a single repository": false,
                                "Developers run tests before pushing and only push when code passes tests": false,
                                "Broken builds are fixed or reverted immediately, and no checkins are made on top of them": false,
                                "Binaries created once for use in all environments": true,
                                "Data migrations and scripts versioned along with the application source code": false
                            },
                            "Deployment": {
                                "Deployment scripts alongside code in a single repository": false,
                                "All release steps tested in a production mirror": true,
                                "Automated deployment to production": false,
                                "Automated smoke tests run during deployment into production": false,
                                "Production can be deployed to without downtime": false,
                                "Problems in production are detectable and visible to the whole team and prioritised like any other work": false,
                                "The health of production systems is easily determinable and visible": true
                            },
                            "Practices": {
                                "Coding standards are agreed upon and followed": true,
                                "Check-ins happen at least once a day": true,
                                "All code is peer reviewed": true,
                                "Changes can be easily reverted": true,
                                "Team practices trunk-based development as a general rule, and knows when it is appropriate to branch": false,
                                "Test results radiated and visible to the whole team": true,
                                "Code is collectively owned, any developer can work on any story": false,
                                "Pair programming used for rapid feedback and is the default way of working in the team": false,
                                "Development and test environment are as similar to production as is economically feasible": true,
                                "Team owns their production system and configuration": false
                            }
                        }
                    }
                };

                var loyalty = {
                    "2015-08-01": {
                        "focus": [
                            "Testers and developers collaborate on writing tests",
                            "All code is peer reviewed",
                            "All new code has automated tests"
                        ],
                        "behaviours": {
                            "Automated Testing": {
                                "A useful level of code coverage is maintained by the team": false,
                                "All new code has automated tests": false,
                                "Single command to run unit tests": false,
                                "Single command to run acceptance tests": false,
                                "Testers and developers collaborate on writing tests": false,
                                "Tests setup their own test data": false,
                                "Tests complete in less than 10 minutes": false,
                                "Unit tests are written first": false
                            },
                            "Continuous Integration": {
                                "Build scripts are alongside code in a single repository": false,
                                "Developers run tests before pushing and only push when code passes tests": false,
                                "Broken builds are fixed or reverted immediately, and no checkins are made on top of them": false,
                                "Binaries created once for use in all environments": false,
                                "Data migrations and scripts versioned along with the application source code": false
                            },
                            "Deployment": {
                                "Deployment scripts alongside code in a single repository": false,
                                "All release steps tested in a production mirror": true,
                                "Automated deployment to production": false,
                                "Automated smoke tests run during deployment into production": false,
                                "Production can be deployed to without downtime": false,
                                "Problems in production are detectable and visible to the whole team and prioritised like any other work": false,
                                "The health of production systems is easily determinable and visible": true
                            },
                            "Practices": {
                                "Coding standards are agreed upon and followed": false,
                                "Check-ins happen at least once a day": false,
                                "All code is peer reviewed": false,
                                "Changes can be easily reverted": false,
                                "Team practices trunk-based development as a general rule, and knows when it is appropriate to branch": false,
                                "Test results radiated and visible to the whole team": false,
                                "Code is collectively owned, any developer can work on any story": false,
                                "Pair programming used for rapid feedback and is the default way of working in the team": false,
                                "Development and test environment are as similar to production as is economically feasible": true,
                                "Team owns their production system and configuration": false
                            }
                        }
                    },
                    "2015-07-01": {
                        "focus": [
                            "Testers and developers collaborate on writing tests",
                            "All code is peer reviewed",
                            "All new code has automated tests"
                        ],
                        "behaviours": {
                            "Automated Testing": {
                                "A useful level of code coverage is maintained by the team": false,
                                "All new code has automated tests": false,
                                "Single command to run unit tests": false,
                                "Single command to run acceptance tests": false,
                                "Testers and developers collaborate on writing tests": false,
                                "Tests setup their own test data": false,
                                "Tests complete in less than 10 minutes": false,
                                "Unit tests are written first": false
                            },
                            "Continuous Integration": {
                                "Build scripts are alongside code in a single repository": false,
                                "Developers run tests before pushing and only push when code passes tests": false,
                                "Broken builds are fixed or reverted immediately, and no checkins are made on top of them": false,
                                "Binaries created once for use in all environments": false,
                                "Data migrations and scripts versioned along with the application source code": false
                            },
                            "Deployment": {
                                "Deployment scripts alongside code in a single repository": false,
                                "All release steps tested in a production mirror": true,
                                "Automated deployment to production": false,
                                "Automated smoke tests run during deployment into production": false,
                                "Production can be deployed to without downtime": false,
                                "Problems in production are detectable and visible to the whole team and prioritised like any other work": false,
                                "The health of production systems is easily determinable and visible": true
                            },
                            "Practices": {
                                "Coding standards are agreed upon and followed": false,
                                "Check-ins happen at least once a day": false,
                                "All code is peer reviewed": false,
                                "Changes can be easily reverted": false,
                                "Team practices trunk-based development as a general rule, and knows when it is appropriate to branch": false,
                                "Test results radiated and visible to the whole team": false,
                                "Code is collectively owned, any developer can work on any story": false,
                                "Pair programming used for rapid feedback and is the default way of working in the team": false,
                                "Development and test environment are as similar to production as is economically feasible": true,
                                "Team owns their production system and configuration": false
                            }
                        }
                    }
                };

                var progressSeries = function(o) {
                    var dates = _.sortBy(_.keys(o), _.identity);

                    return _.map(dates, function(d) {
                        var categories = [
                            "Automated Testing",
                            "Continuous Integration",
                            "Deployment",
                            "Practices"
                        ];

                        var values = _.map(_.keys(o[d]["behaviours"][c]), function(k) {
                            return o[d]["behaviours"][c][k];
                        });

                        return m + _.filter(values, _.identity).length;
                    });
                }

                var progressFor = function(c, o) {
                    var dates = _.sortBy(_.keys(o), _.identity);

                    return _.map(dates, function(d) {
                        var values = _.map(_.keys(o[d]["behaviours"][c]), function(k) {
                            return o[d]["behaviours"][c][k];
                        });

                        return {"x": new Date(d).getTime()/1000, "y": _.filter(values, _.identity).length};
                    });
                }

                var palette = new Rickshaw.Color.Palette( { scheme: 'cool' } );
                var time = new Rickshaw.Fixtures.Time();

                var progressChartFor = function(selector, d) {
                    var g = new Rickshaw.Graph({
                        element: document.querySelector("#" + selector + "-overall"),
                        min: 0,
                        max: 30,
                        interpolation: "step",
                        series: [
                        {
                            name: "Automated Testing",
                            color: palette.color(0),
                            data: progressFor("Automated Testing", d)
                        }, {
                            name: 'Continuous Integration',
                            color: palette.color(1),
                            data: progressFor("Continuous Integration", d)
                        }, {
                            name: 'Deployment',
                            color: palette.color(2),
                            data: progressFor("Deployment", d)
                        }, {
                            name: 'Practices',
                            color: palette.color(3),
                            data: progressFor("Practices", d)
                        }
                      ]
                    });

                    new Rickshaw.Graph.Axis.Y({
                        graph: g,
                        orientation: 'left',
                        tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
                        element: document.getElementById(selector + '-y-axis')
                    });

                    new Rickshaw.Graph.Axis.Time({
                        graph: g
                    });

                    g.render();

                    return g;
                }

                progressChartFor('disrupts', disrupts);
                progressChartFor("loyalty", loyalty);

                _(4).times(function(i) {
                    $(".p" + (i + 1)).css("background-color", palette.color(i));
                });

                var sum = function(a) {
                    return _.reduce(a, function(m, i) { return m + i; }, 0);
                };

                var scoreFor = function(d, o) {
                    var categories = [
                        "Automated Testing",
                        'Continuous Integration',
                        'Deployment',
                        'Practices'
                    ]

                    return sum(
                        _.map(categories, function(c) {
                            return sum(
                                _.map(o[d]["behaviours"][c], function(i) {
                                    return i ? 1 : 0;
                                })
                            );
                        })
                    );
                }

                var recentScore = function(o) {
                    var dates = _.sortBy(_.keys(o), _.identity);
                    var latest = dates[dates.length-1];

                    return scoreFor(latest, o);
                };

                var delta = function(o) {
                    var dates = _.sortBy(_.keys(o), _.identity);
                    var latest = dates[dates.length-1];
                    var prev = dates[dates.length-2];

                    return scoreFor(latest, o) - scoreFor(prev, o);
                }

                $("#loyalty-total").text(recentScore(loyalty));
                $("#disrupts-total").text(recentScore(disrupts));

                var drawDelta = function(selector, team) {
                    d3.select(selector)
                        .selectAll("span")
                        .data([delta(team)])
                        .enter()
                        .append("span")
                            .attr("class", "delta")
                            .text(function(d) { return "" + d; })
                        .append("i")
                            .attr("class", function(d) {
                                if (d > 0) {
                                    return 'fa fa-arrow-up change-i up';
                                } else if (d < 0) {
                                    return 'fa fa-arrow-down change-i down';
                                } else {
                                    return "fa fa-exchange change-i eq";
                                }
                            });
                };

                drawDelta("#disrupts-delta", disrupts);
                drawDelta("#loyalty-delta", loyalty);

                var drawFocus = function(selector, team) {
                    var dates = _.sortBy(_.keys(team), _.identity);
                    var latest = dates[dates.length-1];

                    var li = d3.select(selector)
                                .append("ul")
                                    .attr("class", "fa-ul focus-list")
                                    .selectAll("ul")
                                    .data(team[latest]["focus"])
                                    .enter()
                                    .append("li");
                    li.append("i")
                        .attr("class", "fa fa-li fa-check-square-o");

                    li.append("span")
                        .text(function(d) { return d; });
                }

                drawFocus("#disrupts-focus", disrupts);
                drawFocus("#loyalty-focus", loyalty);
            });
        </script>
    </head>

    <body class='antialiased'>
        <h1>cd progress</h1>

        <h2>disrupts self-service</h2>
        <div class="info">
            <div class="score">
                <div>
                    <div id="disrupts-total" class="total"></div>
                    <div id="disrupts-delta" class="delta"></div>
                    <div class="clear"></div>
                </div>

                <div id="disrupts-focus" class="focus">
                    <h3>Current focus areas</h3>
                </div>
            </div>
            <div id="disrupts-focus">
            </div>
            <div class="chart-container">
                <div id="disrupts-y-axis" class="cd-checklist-chart-y-axis"></div>
                <div id="disrupts-overall" class="cd-checklist-chart"></div>
            </div>
        </div>

        <h2>loyalty</h2>
        <div class="info">
            <div class="score">
                <div>
                    <div id="loyalty-total" class="total"></div>
                    <div id="loyalty-delta" class="delta"></div>
                    <div class="clear"></div>
                </div>

                <div id="loyalty-focus" class="focus">
                    <h3>Current focus areas</h3>
                </div>
            </div>

            <div class="chart-container">
                <div id="loyalty-y-axis" class="cd-checklist-chart-y-axis"></div>
                <div id="loyalty-overall" class="cd-checklist-chart"></div>
            </div>
        </div>

        <div id="legend">
            <div>
                <div class="item p1"></div>
                Automated Testing
            </div>
            <div>
                <div class="item p2"></div>
                Continuous Integration
            </div>
            <div>
                <div class="item p3"></div>
                Deployment
            </div>
            <div>
                <div class="item p4"></div>
                Practices
            </div>
        </div>
    </body>
</html>
